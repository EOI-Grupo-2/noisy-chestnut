<!DOCTYPE html>
<html lang="es" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/main_layout.html}"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${concert.name != null ? concert.name : 'Detalles del Concierto'}">Detalles del Concierto</title>
    <link rel="stylesheet" th:href="@{/css/concert-detail.css}" />
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Condensed&family=Roboto:wght@300&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@48,400,0,0" />
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const attendButton = document.getElementById('attendButton');
            const attendCount = document.getElementById('attendCount');
            let isAttending = false;
            let count = parseInt(attendCount.textContent);

            attendButton.addEventListener('click', function() {
                if (!isAttending) {
                    count++;
                    isAttending = true;
                    attendButton.classList.add('active');
                } else {
                    count--;
                    isAttending = false;
                    attendButton.classList.remove('active');
                }
                attendCount.textContent = count;
            });
        });

        // Funci√≥n para compartir concierto
        function shareConcierto() {
            const concertTitle = /*[[${concert.name}]]*/ 'Concierto';
            const concertUrl = window.location.href;
            const concertDate = /*[[${#temporals.format(concert.date, 'dd/MM/yyyy HH:mm')}]]*/ '';
            const concertPlace = /*[[${concert.place != null ? concert.place.name : ''}]]*/ '';

            const shareText = `üé∏ ¬°Ven al ${concertTitle}!\nüìÖ ${concertDate}\nüìç ${concertPlace}\n\n${concertUrl}`;

            // Si el navegador soporta Web Share API (m√≥viles principalmente)
            if (navigator.share) {
                navigator.share({
                    title: concertTitle,
                    text: `üé∏ ¬°Ven al ${concertTitle}! üìÖ ${concertDate} üìç ${concertPlace}`,
                    url: concertUrl
                }).catch(err => console.log('Error sharing:', err));
            }
            // Si no, copiar al portapapeles
            else {
                navigator.clipboard.writeText(shareText).then(() => {
                    // Mostrar mensaje de confirmaci√≥n
                    showShareMessage();
                }).catch(() => {
                    // Fallback: mostrar el texto para copiar manualmente
                    prompt('Copia este enlace para compartir:', shareText);
                });
            }
        }

        // Mostrar mensaje de confirmaci√≥n
        function showShareMessage() {
            // Crear elemento de notificaci√≥n
            const notification = document.createElement('div');
            notification.innerHTML = '‚úÖ ¬°Enlace copiado al portapapeles!';
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #4CAF50;
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                z-index: 1000;
                font-weight: bold;
                animation: slideIn 0.3s ease;
            `;

            // A√±adir animaci√≥n CSS
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideIn {
                    from { transform: translateX(100%); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
            `;
            document.head.appendChild(style);

            // Mostrar notificaci√≥n
            document.body.appendChild(notification);

            // Quitar despu√©s de 3 segundos
            setTimeout(() => {
                notification.remove();
                style.remove();
            }, 3000);
        }
    </script>
</head>
<body>
<div layout:fragment="content" class="content">
    <a href="/concert" class="btn-back">
        <span class="material-symbols-outlined">arrow_back</span> Volver a conciertos
    </a>

    <div class="concert-detail">
        <div class="concert-header">
            <img th:src="${concert.imageUrl != null ? concert.imageUrl : 'https://images.unsplash.com/photo-1540039155733-5bb30b53aa14?ixlib=rb-1.2.1&auto=format&fit=crop&w=1350&q=80'}"
                 th:alt="'Imagen de ' + ${concert.name}"
                 class="concert-header__image">
            <h1 class="concert-header__title" th:text="${concert.name}">Nombre del Concierto</h1>
        </div>

        <div class="concert-content">
            <div class="concert-info">
                <div class="concert-info__item">
                    <span class="material-symbols-outlined">calendar_month</span>
                    <span th:text="${#temporals.format(concert.date, 'dd/MM/yyyy HH:mm')}">Fecha y hora</span>
                </div>
                <div class="concert-info__item">
                    <span class="material-symbols-outlined">location_on</span>
                    <a href="/place" class="venue-link"
                       th:text="${concert.place != null ? concert.place.name + ', ' + concert.place.address : 'Lugar no especificado'}">
                       Lugar del concierto
                    </a>
                </div>
                <div class="concert-info__item">
                    <span class="material-symbols-outlined">music_note</span>
                    <span th:text="${concert.musicGenre != null ? concert.musicGenre : 'G√©nero no especificado'}">G√©nero musical</span>
                </div>
                <div class="concert-info__item" th:if="${concert.place != null and concert.place.capacity != null}">
                    <span class="material-symbols-outlined">group</span>
                    <span th:text="'Capacidad: ' + ${concert.place.capacity} + ' personas'">Capacidad</span>
                </div>
            </div>

            <div class="concert-description">
                <h2 class="concert-description__title">Descripci√≥n</h2>
                <p class="concert-description__text" th:text="${concert.description}">Descripci√≥n del concierto</p>
            </div>

            <!-- Secci√≥n de Artistas (m√∫ltiples) -->
            <div class="concert-artists" th:if="${concert.users != null and !#lists.isEmpty(concert.users)}">
                <h2 class="concert-artists__title">
                    <span th:text="${#lists.size(concert.users) == 1 ? 'Artista' : 'Artistas'}">Artistas</span>
                </h2>

                <div class="concert-artists__grid">
                    <div class="concert-artist__card" th:each="artist : ${concert.users}">
                        <img th:src="${artist.imageUrl != null ? artist.imageUrl : 'https://images.unsplash.com/photo-1511367461989-f85a21fda167?ixlib=rb-1.2.1&auto=format&fit=crop&w=1350&q=80'}"
                             th:alt="'Imagen de ' + ${artist.name}"
                             class="concert-artist__image">
                        <div class="concert-artist__info">
                            <div class="concert-artist__info-header">
                                <h3 class="concert-artist__name" th:text="${artist.name}">Nombre del Artista</h3>
                                <div class="concert-artist__rating" th:if="${artist.rate != null}">
                                    <span th:text="${artist.rate}">0.0</span>
                                    <span class="material-symbols-outlined">star</span>
                                </div>
                            </div>
                            <p class="concert-artist__genre" th:text="${artist.musicGenre}">G√©nero musical</p>
                            <p class="concert-artist__biography"
                               th:text="${artist.description != null ? artist.description : 'Sin descripci√≥n disponible'}">
                               Biograf√≠a del artista
                            </p>
                            <a th:href="@{/users/{id}/profile(id=${artist.id})}" class="concert-artist__button">Ver perfil completo</a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Mensaje si no hay artistas -->
            <div class="no-artists" th:if="${concert.users == null or #lists.isEmpty(concert.users)}">
                <h2>Artistas</h2>
                <p>No hay artistas asignados a este concierto.</p>
            </div>

            <div class="concert-actions">
                <!-- Botones de compra de entradas (din√°micos seg√∫n puntos de venta) -->
                <div th:if="${salePoints != null and !#lists.isEmpty(salePoints)}" class="ticket-buttons">
                    <a th:each="salePoint : ${salePoints}"
                       th:href="${salePoint.salePointUrl}"
                       target="_blank"
                       class="concert-actions__btn concert-actions__btn--buy">
                        <span class="material-symbols-outlined">local_activity</span>
                        <span th:text="'Comprar entradas (' + ${salePoint.ticketPrice} + '‚Ç¨)'">Comprar entradas</span>
                    </a>
                </div>

                <!-- Bot√≥n gen√©rico si no hay puntos de venta -->
                <div th:if="${salePoints == null or #lists.isEmpty(salePoints)}">
                    <button class="concert-actions__btn concert-actions__btn--buy" disabled>
                        <span class="material-symbols-outlined">local_activity</span> Entradas no disponibles
                    </button>
                </div>

                <button class="concert-actions__btn concert-actions__btn--attend" id="attendButton">
                    <span class="material-symbols-outlined">event_available</span> Asistir√©
                    <span class="concert-actions__count" id="attendCount"
                          th:text="${concert.users != null ? #lists.size(concert.users) * 10 + 12 : 42}">42</span>
                </button>

                <button class="concert-actions__btn concert-actions__btn--share" onclick="shareConcierto()">
                    <span class="material-symbols-outlined">share</span> Compartir
                </button>
            </div>
        </div>

        <div class="concert-comments">
            <h2 class="concert-comments__title">Comentarios</h2>

            <!-- Formulario para a√±adir comentario -->
            <div th:if="${#authorization.expression('isAuthenticated()')}">
                <form class="concert-comments__form" method="post" th:action="@{'/concert/' + ${concert.id} + '/comment'}">
                    <textarea name="content" class="concert-comments__textbox" rows="3"
                             placeholder="Escribe un comentario..." required></textarea>
                    <button type="submit" class="concert-comments__button">Comentar</button>
                </form>
            </div>

            <!-- Mensaje para usuarios no autenticados -->
            <div th:if="${!#authorization.expression('isAuthenticated()')}" class="login-message">
                <p><a href="/users/login">Inicia sesi√≥n</a> para comentar</p>
            </div>

            <!-- Lista de comentarios -->
            <div class="concert-comments__items">
                <div th:if="${comments != null and !#lists.isEmpty(comments)}">
                    <div class="concert-comments__item" th:each="comment : ${comments}">
                        <img th:src="${comment.user.imageUrl != null ? comment.user.imageUrl : 'https://images.unsplash.com/photo-1535713875002-d1d0cf377fde?ixlib=rb-1.2.1&auto=format&fit=crop&w=800&q=80'}"
                             alt="Avatar de usuario" class="concert-comments__avatar">
                        <div class="concert-comments__content">
                            <div class="concert-comments__header">
                                <h4 class="concert-comments__username" th:text="${comment.user.name}">Usuario</h4>
                                <span class="concert-comments__date"
                                      th:text="${#temporals.format(comment.date, 'dd/MM/yyyy HH:mm')}">Fecha</span>
                            </div>
                            <p class="concert-comments__text" th:text="${comment.content}">Comentario</p>
                        </div>
                    </div>
                </div>

                <!-- Mensaje si no hay comentarios -->
                <div th:if="${comments == null or #lists.isEmpty(comments)}" class="no-comments">
                    <p>S√© el primero en comentar este concierto üé∏</p>
                </div>
            </div>
        </div>
    </div>
</div>
</body>
</html>